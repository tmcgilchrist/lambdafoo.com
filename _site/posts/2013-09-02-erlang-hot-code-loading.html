<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>My Hakyll Blog - Erlang hot code loading</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../css/screen.css" />
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../">My Hakyll Blog</a>
            </div>
            <div id="navigation">
                <a href="../">Home</a>
                <a href="../about.html">About</a>
                <a href="../talks.html">Talks</a>
                <a href="../archive.html">Archive</a>
            </div>
        </div>

        <div id="content">
            <h1>Erlang hot code loading</h1>

            <div class="info">
    Posted on September  2, 2013
    
</div>

<p>Nearly every posting about Erlang that you come across mentions the hot code loading feature, aka dynamic code loading. But so far I have had problems finding a simple example of how to add this to my code. So here is one.</p>
<p>Copy this code into an editor. I’m using Emacs here, so all instructions use it’s keybindings.</p>
<p>{% codeblock lang:erlang %}</p>
<p>%% A process whose only job is to keep a counter. -module(counter). -export([start/0, codeswitch/1]).</p>
<p>start() -&gt; loop(0).</p>
<p>loop(Sum) -&gt; receive {increment, Count} -&gt; loop(Sum+Count); {print} -&gt; io:format(“Sum is <sub>p</sub>n”, [Sum]), loop(Sum); {counter, Pid} -&gt; Pid ! {counter, Sum}, loop(Sum); code_switch -&gt; ?MODULE:codeswitch(Sum); M -&gt; io:format(“Unhandled message <sub>p</sub>n”, [M]), loop(Sum) end.</p>
<p>codeswitch(Sum) -&gt; loop(Sum). {% endcodeblock %}</p>
<p>Compile and start a new erlang shell, Ctrl-C Ctrl-K.</p>
<p>Now we want to start a new process running this code. Startup and enter the following code into the erlang shell.</p>
<p>{% codeblock %}</p>
<p>Erlang R15B (erts-5.9) [source] [64-bit] [smp:8:8] [async-threads:0] [hipe] [kernel-poll:false]</p>
<p>Eshell V5.9 (abort with ^G) 1&gt; Pid = spawn(fun() -&gt; counter:start() end). &lt;0.37.0&gt;</p>
<p>{% endcodeblock %}</p>
<p>Send the process a message to make sure it’s alive and working.</p>
<p>{% codeblock %}</p>
<p>3&gt; Pid ! {increment, 3}. {increment,3} 4&gt; Pid ! {print}. Sum is 3 {print}</p>
<p>{% endcodeblock %}</p>
<p>Now that we have the first version of the process running, add a new clause to the receive like so.</p>
<p>{% codeblock lang:erlang %} {print} -&gt; io:format(“Sum is <sub>p</sub>n”, [Sum]), loop(Sum); {reset} -&gt; loop(0); {counter, Pid} -&gt; Pid ! {counter, Sum}, loop(Sum); {% endcodeblock %}</p>
<p>Compile this version, Ctrl-C Ctrl-K and send a message to the process that only the new version can handle.</p>
<p>{% codeblock %}</p>
<p>6&gt; Pid ! {reset}. Unhandled message {reset} {reset}</p>
<p>{% endcodeblock %}</p>
<p>So we are still running the previous version of the code.</p>
<p>{% codeblock %}</p>
<p>6&gt; Pid ! code_switch. code_switch 7&gt; Pid ! {print}. Sum is 3 {print} 8&gt; Pid ! {reset}. {reset} 9&gt; Pid ! {print}. Sum is 0 {print}</p>
<p>{% endcodeblock %}</p>
<p>The ‘code_switch’ message makes the process load the new version of code. So using this you can upgrade the running process without losing state. Cool.</p>

        </div>
        <div id="footer">
            Site proudly generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </div>
    </body>
</html>
